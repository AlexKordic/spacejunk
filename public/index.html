<html>
<head>
  <title>Satellites</title>
  <link rel="stylesheet" href="stylesheets/styles.css">

  <!-- ************ LIBRARIES ************ -->
  <script src="vendor/three.min.js"></script>
  <script src="vendor/jquery.js"></script>

  <!-- ************ SCRIPTS ************ -->
  <script src="javascripts/scripts.js"></script>
  <script src="javascripts/sgp.js"></script>
  <script src="javascripts/OrbitControls.js"></script>
</head>
<body>

  <div id="details">
    <ul id="satellites"></ul>
  </div>


<script>
  // init
  var HEIGHT   = window.innerHeight,
      WIDTH    = window.innerWidth;

  var earthRadius = 6371,
      timeStart   = Date.now() / 1000,
      siderealTime = getMST() * Math.PI / 180,
      speedFactor = 2;                  // 24: 1day == 1min, 4: 1day = 6min

  var renderer, scene, camera, geometry, material, earthMesh,
      light, controls;

  var satellites, satTarget;

  var tracking = false,
      center = new THREE.Vector3();

  var priorTime = timeStart,
      elapsed = 0;

  $.getJSON("/satdata", function(data){

    satellites = data;
    satellites.forEach(function(sat){
      sat.minSinceEpoch = (timeStart - JulianToUnix(sat.epoch_date)/1000)/60
    });
    satTarget = satellites[0];

    function init() {
      // initialize WebGL objects

      renderer = new THREE.WebGLRenderer();
      renderer.setSize(WIDTH, HEIGHT);
      document.body.appendChild(renderer.domElement);
      scene  = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(45, WIDTH/HEIGHT, 1, 500000);
      camera.position.z = earthRadius * 3;
      scene.add(camera)

      // EARTH
      geometry                = new THREE.SphereGeometry(earthRadius, 50, 50);
      material                = new THREE.MeshPhongMaterial();
      material.map            = THREE.ImageUtils.loadTexture("images/earthmap1k.jpg");
      material.bumpMap        = THREE.ImageUtils.loadTexture("images/earthbump1k.jpg");
      material.bumpScale      = earthRadius / 10;
      material.specularMap    = THREE.ImageUtils.loadTexture("images/earthspec1k.jpg");
      material.specular       = new THREE.Color("grey");
      earthMesh               = new THREE.Mesh(geometry, material);

      earthMesh.rotateY(-Math.PI/2 + siderealTime)              // aligns to [0,0] and then adjusts to sidereal time
      scene.add(earthMesh)

      // LIGHT
      scene.add(new THREE.AmbientLight(0x888888));
      light = new THREE.DirectionalLight(0xcccccc, .6);
      light.position.set(-1000000,432738.64224742586,0);        // Creates 23.4 degree angle of axial tilt
      scene.add(light);

      // SATELLITES
      satSphere = new THREE.SphereGeometry(30);
      satellites.forEach(function(sat) {
        // creates each satellite sphere

        sat.satMesh   = new THREE.Mesh(satSphere, new THREE.MeshBasicMaterial({ color: 0x87c540 }));
        scene.add(sat.satMesh);
      })

      // MOUSE CONTROLS
      controls = new THREE.OrbitControls(camera, renderer.domElement);

      // WINDOW RESIZE
      window.addEventListener('resize', function() {
        var WIDTH = window.innerWidth,
            HEIGHT = window.innerHeight;

        renderer.setSize(WIDTH, HEIGHT);
        camera.aspect = WIDTH / HEIGHT;
        camera.updateProjectionMatrix();
      });
    }

    function render() {
      timeNow = Date.now() / 1000;
      delta   = timeNow - priorTime;

      satellites.forEach(function(sat){
        // the sgp() function accepts the second argument in the form of minutes
        // since delta is calculated in seconds, the function calculates time as
        // 1 satellite minute = 1 browser second
        // the sgp() model uses z as the rotational axis, and x points to the vernal equinox
        // use the order Y,Z,X in any calculations coming from SGP to THREE
        var location = sgp(sat, sat.minSinceEpoch + elapsed + delta*speedFactor);
        sat.satMesh.position.z = location.X;
        sat.satMesh.position.x = location.Y;
        sat.satMesh.position.y = location.Z;
      });

      if (tracking == true) {
        // checks for tracking flag which is triggered on click from the satellite list(not yet implemented)

        var camLocation = sgp(satTarget, satTarget.minSinceEpoch + elapsed + delta*speedFactor);
        var trackPosition = new THREE.Vector3(camLocation.Y - 600*camLocation.YDOT,camLocation.Z - 600*camLocation.ZDOT,camLocation.X - 600*camLocation.XDOT);
        var trackTarget = new THREE.Vector3(camLocation.Y + 1000*camLocation.YDOT,camLocation.Z + 1000*camLocation.ZDOT,camLocation.X + 1000*camLocation.XDOT);

        // aligns the camera with the earth underneath
        camera.up = new THREE.Vector3(10*camLocation.Y, 10*camLocation.Z, 10*camLocation.X);
        camera.lookAt(trackTarget);
        camera.position.copy(trackPosition);
      } else {
        // resets the up angle, re-initializing the orbit controls
        camera.up = new THREE.Vector3(0,1,0);
        camera.lookAt(center);
      }

      // 1 rotation per second = 2 * Math.PI * delta
      // 2*pi*delta/1440 is setting 1 earth minute equal to 1 browser second
      // this allows speedFactor to control both the sgp() function and earth rotation
      earthMesh.rotateY(speedFactor * 2 * Math.PI * delta / 1440 );
      renderer.render(scene, camera);
      elapsed  = elapsed + delta*speedFactor;
      priorTime = timeNow;
    }

    function animate() {
      requestAnimationFrame(animate);
      render();
      controls.update();
    }

    init();
    animate();

    // satellites.forEach(function(sat){
    //   $("#satellites").append("<li id="+sat.norad_id+">" + sat.name + "</li>");
    // })
  });
</script>
</body>
</html>
